---
- hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
    - name: Ensure AWS long lived credentials are configured
      ansible.builtin.shell:
        cmd: |
          export AWS_DEFAULT_PROFILE=rosa
          aws configure set region ap-southeast-2 --profile rosa
          aws configure set aws_access_key_id "{{ aws_access_key_id }}" --profile rosa
          aws configure set aws_secret_access_key "{{ aws_secret_access_key }}" --profile rosa
          aws configure set profile rosa
          rosa login --token "{{ rosa_token }}"
      no_log: true

    - name: Run network validation tests
      ansible.builtin.shell:
        cmd: |
          export AWS_DEFAULT_PROFILE=rosa
          rosa verify network --watch --status-only --subnet-ids "{{ rosa_subnets | map(attribute='id') | join(',') }}" --region="ap-southeast-2" --role-arn="arn:aws:iam::{{ rosa_aws_account_id }}:role/{{ rosa_aws_role_name }}"
      register: egress_validation
      no_log: true

    - name: Validate egress configuration
      ansible.builtin.fail:
        msg: |
          Egress validation failed:
            {{ egress_validation.stdout }}
      when: "'failed Unable to verify egress' in egress_validation.stdout"