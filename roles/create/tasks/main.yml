---
- name: Create work directory
  ansible.builtin.file:
    path: "{{ work_dir }}/{{ rosa_cluster_name }}/terraform/clusters/"
    state: directory
    mode: '0755'

- name: Create s3 bucket to store state
  environment:
    AWS_DEFAULT_PROFILE: rosa
  amazon.cloud.s3_bucket:
    bucket_name:  "{{ rosa_cluster_name }}-terraform"
    state: present

- name: Copy terraform module to work_dir
  ansible.builtin.copy:
    src: files/terraform/
    dest: "{{ work_dir }}/{{ rosa_cluster_name }}/terraform/"

- name: Copy terraform files to work_dir
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ work_dir }}/{{ rosa_cluster_name }}/terraform/{{ item }}"
  with_items:
    - output.tf
    - variables.tf
    - data.tf

- name: "Create ROSA cluster: {{ rosa_cluster_name }}"
  environment:
    TF_BACKEND_BUCKET: "{{ rosa_cluster_name }}-terraform"
    TF_LOG: debug
    TF_LOG_PATH: "{{ work_dir }}/tf_rosa_deploy.log"
    AWS_DEFAULT_PROFILE: rosa
  cloud.terraform.terraform:
    complex_vars: false
    force_init: true
    project_path: "{{ work_dir }}/{{ rosa_cluster_name }}/terraform"
    provider_upgrade: true
    state: present
    variables:
      token: "{{ rosa_token }}"
      AWS_ACCESS_KEY_ID: "{{ aws_access_key_id }}"
      AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key }}"
      AWS_DEFAULT_REGION: "{{ rosa_region }}"
  register: "create"

- name: "Show output"
  ansible.builtin.debug:
    msg: "{{ create.outputs }}"