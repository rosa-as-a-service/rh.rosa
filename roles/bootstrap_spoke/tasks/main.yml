---
# tasks file for bootstrap-spoke
- name: Ensure AWS long lived credentials are configured on the bastion
  ansible.builtin.shell:
    cmd: |
      export AWS_DEFAULT_PROFILE=rosa
      aws configure set region ap-southeast-2 --profile rosa
      aws configure set aws_access_key_id "{{ aws_access_key_id }}" --profile rosa
      aws configure set aws_secret_access_key "{{ aws_secret_access_key }}" --profile rosa
      aws configure set profile rosa
      rosa login --token "{{ rosa_token }}"
  no_log: true
  changed_when: false

- name: Get cluster API URL
  ansible.builtin.shell:
    cmd: |
      export AWS_DEFAULT_PROFILE=rosa
      rosa describe cluster --cluster={{ rosa_cluster_name }} --output=json | jq -r '.dns.base_domain'
  register: api_base_domain
  failed_when: "'Not logged in' in api_base_domain.stderr"

- name: Set Spoke API URL
  ansible.builtin.set_fact:
    boostrap_hub_api_url: "https://api.{{ rosa_cluster_name }}.{{ api_base_domain.stdout }}:6443"